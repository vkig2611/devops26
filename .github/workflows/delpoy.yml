name: Zip and Send Notification.txt to Slack

on:
  push:
    branches:
      - main

jobs:
  zip-and-send:
    runs-on: ubuntu-latest

    steps:
      # ... (Checkout and Zip steps remain the same)

      - name: Get file size
        id: file_size
        run: echo "size=$(stat -c%s output.zip)" >> $GITHUB_OUTPUT

      - name: Get upload URL from Slack
        id: get_upload_url
        run: |
          response=$(curl -X POST -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"length": ${{ steps.file_size.outputs.size }}}' \
            https://slack.com/api/files.getUploadURLExternal)

          echo "Slack API Response: $response"  # Debug: Print the full response

          if [[ $(echo "$response" | jq -r '.ok') == "true" ]]; then  # Check for success
            echo "upload_url=$(echo "$response" | jq -r '.upload_url')" >> $GITHUB_OUTPUT
            echo "file_id=$(echo "$response" | jq -r '.file_id')" >> $GITHUB_OUTPUT
          else
            echo "Error getting upload URL from Slack:"
            echo "$response"  # Print the error response
            exit 1  # Fail the workflow
          fi

      - name: Upload file to Slack
        if: steps.get_upload_url.outputs.upload_url != '' # Only run if upload URL is available
        run: |
          curl -F file=@output.zip \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            "${{ steps.get_upload_url.outputs.upload_url }}" || exit 1 # Fail if upload fails

      - name: Complete file upload
        if: steps.get_upload_url.outputs.upload_url != '' # Only run if upload URL is available
        run: |
          curl -X POST -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"files": [{"id": "${{ steps.get_upload_url.outputs.file_id }}", "title": "output.zip"}], "channels": "${{ secrets.SLACK_CHANNEL }}"}' \
            https://slack.com/api/files.completeUploadExternal || exit 1 # Fail if completion fails

      # ... (Cleanup step remains the same)
